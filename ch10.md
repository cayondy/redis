# 10. 클러스터

## 레디스 클러스터와 확장성

**스케일 업**
- 서버의 하드웨어를 높은 사양으로 업그레이드
- 보통 디스크를 추가하거나 CPU, 메모리를 업그레이드 함
- 서버 능력을 증강 시키기 때문에 **수직 확장**이라고 함
- 간단하고 비용이 적게 들지만 한계가 있음
- maxmemory 값이 증가

**스케일 아웃**
- 장비를 추가해 시스템을 확장
- 비슷한 사양의 서버를 추가로 연결해 성능을 높임
- 대수가 증가하는 것이므로 **수평 확장**이라고 함
- 추가하는 만큼 성능의 확장이 가능하지만 분산 처리에 대한 로직의 추가 개발 필요
- 레디스 처리량의 증가 (여러 서버에서 병렬로 처리하므로)

### 레디스 클러스터의 기능

>**데이터 샤딩**
>: 데이터 저장소를 수평 확장하며 여러 서버 간에 데이터를 분할하는 데이터 베이스 아키텍처 패턴

- 레디스에서 클러스터 기능 사용 시 마스터를 최대 1000개 까지 확장 가능
- 데이터 샤딩과 관련한 데이터는 모두 레디스 내부에서 자체적으로 관리
- 데이터는 키를 통해 샤딩되며 클러스터에서 노드가 추가,변경되지 않는 이상 하나의 키는 항상 하나의 마스터 노드에 매핑
- 클라이언트가 다른 노드의 데이터에 접근할 때는 키가 할당된 마스터 노드로 리디렉션
- 위 과정은 레디스 노드와 애플리케이션 쪽의 레디스 클라이언트에서 처리
	- 데이터를 분할 저장 시 애플리케이션 소스 변경 X
- 클라이언트는 클러스터 내에서 특정 키가 어떤 마스터에 연결되어 있는지의 정보를 캐싱 가능
	- 매번 키를 저장할 노드를 찾지 않아도 되고, 키를 찾는 시간도 단축

### 고가용성

- 클러스터는 각각 최소 3대의 마스터, 복제본 노드를 갖도록 구성하는 것이 일반적이다.
- 하나의 클러스터 구성에 속한 각 노드는 서로를 모니터링한다.
- 마스터에 장애 발생 시, 장애를 인지한 노드들이 마스터에 연결됐던 복제본 노드를 마스터로 자동 페일오버 시킨다. -> 가용성 증가
- 마스터에 연결된 복제본의 개수를 파악해 잉여 복제본을 필요한 노드에 연결시키는 마이그레이션 작업도 수행한다.


- 클러스터 내의 노드들은 **클러스터 버스**라는 **독립적인 통신**을 이용한다.
- 모든 레디스 클러스터 노드는 다른 레디스 클러스터 노드에서 들어오는 연결을 수신하기 위한 TCP 포트가 열려있다.
- 이는 클라이언트로부터 커맨드를 받는 TCP 노드와는 독립되게 동작한다.
	- cluster_bus_port 값을 정의하지 않는 경우,
	- 클러스터 버스 포트 = 레디스 포트 + 10000

>**클러스터 노드의 연결 구조**
>- 클러스터는 TCP 연결을 사용해 모든 노드가 다른 모든 노드와 연결돼 있는 **풀 메쉬 포톨로지** 형태이다.
>- 클러스터가 N개의 노드이면, 모든 노드는 N-1개의 다른 노드와 송수신 TCP 연결되어 있다.
>- 가십 프로토콜과 구성 업데이트 메커니즘으로 정상적인 상태에서는 노드 간 너무 많은 메시지를 교환하지는 않으므로 오버헤드 가능성은 낮다.


## 레디스 클러스터 동작 방법

### 해시슬롯을 이용한 데이터 샤딩

- 클러스터 구조에서 모든 데이터는 해시슬롯에 저장된다.
- 레디스는 총 16,384개의 해시슬롯을 갖고 있다.
- 마스터 노드는 각각 해시슬롯을 균등하게 나눠 갖고 있다.
- 레디스에 입력되는 모든 키는 하나의 해시슬롯에 매핑된다.

```
// 해시함수
HASH_SLOT = CRC16(key) mod 16384
```

- 해시슬롯은 마스터 노드 내에서 자유롭게 옮겨질 수 있고, 옮겨지는 중에도 데이터에 접근이 가능하다.
- 하나의 클러스터 내에서 마스터 노드의 추가, 삭제는 간단하게 처리된다.
- 마스터 노드가 추가되는 경우, 기존 노드가 갖고 있던 해시슬롯 일부를 신규 마스터로 이동시켜주면 된다.
- 마스터 노드가 삭제되는 경우에도 기존 노드가 갖고 있던 해시슬롯을 전부 다른 마스터로 이동시킨 다음 노드를 클러스터에서 제외하면 된다. 

### 해시태그

- 클러스터를 사용할 때는 다중 키 커맨드를 사용할 수 없다.
- 클러스터는 키를 이용해 커맨드를 처리할 마스터로 리디렉션하기 때문에 다른 마스터에 있는 2개 이상의 키에 접근해야 하는 커맨드는 처리할 수 없다.
```
// 클러스터에서는 사용 불가
MGET user1:name user2:name
```

- **해시태그**: 키에 대괄호를 사용해 대괄호 사이에 있는 값을 해시하여 같은 해시슬롯에 저장될 수 있게 하는 기능
```
user:{123}:profile
user:{123}:account
```

| 키                    | 해시되는 값   | 규칙                       |
| -------------------- | -------- | ------------------------ |
| {user1000}.followers | user1000 | 괄호 안의 값                  |
| user{}id             | user{}id | 괄호 안의 값이 없으므로 키 전체       |
| user{{name}}id       | {name    | 첫번째 { 다음부터 첫번째 } 안의 값 까지 |
| user{name}{id}       | name     | 첫번째 { 다음부터 첫번째 } 안의 값 까지 |
- 너무 많은 키가 같은 해시태그를 갖고 있다면 데이터가 몰릴 수 있으므로 키 분배 모니터링이 필요

```
// 해시태그 사용 시 다중 키 커맨드 사용 가능
MGET {user}1:name {user}2:name
```


### 자동 재구성

**자동 페일오버**
- 어떤 마스터에 장애 발생 시 해당 복제본이 페일오버를 해도 될 지 투표를 요청하고 다른 마스터 노드의 과반 이상이 투표하면 해당 복제본이 마스터로 승격한다.

**자동 복제본 마이그레이션**
- 각 마스터에 연결된 복제본 노드의 불균형이 발생할 때 가장 많은 수의 복제본이 연결된 마스터의 복제본 중 하나를 다른 마스터로 이동시킨다.
