# 09. 센티널

## 센티널이란?

- 데이터를 저장하는 기존 레디스 인스턴스와는 다른 역할을 하는 별도의 프로그램
- 자동 페일오버 기능을 사용하면 장애 발생 시 레디스의 다운타임을 최서화 할 수 있다.

### 센티널 기능

**모니터링**
- 마스터 복제본 인스턴스 상태를 실시간으로 확인

**자동 페일오버**
- 마스터의 비정상 상태를 감지해 정상 상태의 복제본 중 하나를 마스터로 승격
- 기존 마스터에 연결된 복제본은 새롭게 승격된 마스터에 연결

**인스턴스 구성 정보 안내**
- 클라이언트에게 현재 구성에서의 마스터 정보를 알려준다.
- 페일오버가 발생하면 변경된 마스터 정보를 재전달하기 때문에 따로 레디스의 엔드포인트 정보를 변경해주지 않아도 된다.

### 분산 시스템으로 동작하는 센티널

>**SPOF (Single Point Of Failure)**
> : 하나의 서비스에 문제가 발생했을 때 전체 시스템이 영향을 받는 지점

- 센티널은 SPOF 되는 것을 방지하기 위해 최소 3대 이상일 때 정상적으로 동작할 수 있도록 설계
- 클라이언트는 센티널에 먼저 열결해 마스터의 정보를 받아온다.
- 마스터와 복제본 인스턴스가 정상이여도 센티널 인스턴스의 문제로 마스터 정보를 반환하지 못하면 클라이언트는 레디스로 새로운 커넥션을 맺을 수 없다. 
- 3대의 센티널이 동작하면 하나의 센티널에 문제가 생겼을 때 다른 센티널에서 마스터의 정보를 받아온다.

> **쿼럼 (quorum)**
> : 마스터가 비정상 동작을 한다는 것에 동의해야하는 센티널의 수

- 쿼럼을 만족하는 경우 페일오버를 시작한다.
- 일반적으로 센티널 인스턴스가 3개이면, 쿼럼은 2로 설정
- 센티널은 쿼럼을 이용한 과반수 선출 개념을 사용하기 때문에 3대 이상의 홀수로 구성하는 것이 좋다.


### 센티널 인스턴스 배치 방법

- 센티널 인스턴스는 물리적으로 서로 영향을 받지 않는 서버에서 실행되는 것이 좋다.
- 마스터의 장애를 감지할 수 있어야 하기 때문에 서로 다른 가용 영역에 배치하는 것이 일반적
- 같은 영역에서 동시에 죽으면 장애 감지 기능 자체가 의미 없기 때문

| 배치 방법                                                                   | 성능                                                |
| ----------------------------------------------------------------------- | ------------------------------------------------- |
| ( Master + Sentinel ) * 1<br>( Replica + Sentinel ) * 2                 | - 서버 리소스에 여유가 있는 경우<br>- 안정적                      |
| ( Master + Sentinel ) * 1<br>( Replica + Sentinel ) * 1<br>Sentinel * 1 | - 센티널만 있는 서버는 최저 사양으로 구성 가능<br>- 리소스 비용은 아끼면서 안정적 |

## 센티널 운영하기

### 센티널의 자동 페일오버 과정
1. 마스터의 장애 상황 감지 (파라미터에 지정된 값 이상 동안 응답이 없을 시)
2. sdown, odown 실패 상태로 전환
	- sdown (subjectly down): 주관적인 다운 상태
	- odown (objectly down): 객관적인 다운 상태
	- 자기 자신을 포함해 쿼럼값 이상의 센티널 노드가 장애를 인식하면 마스터를 odown 상태로 변경
	- 복사본 노드 장애는 해당 복사본 노드를 sdown 상태로 변경
3. 에포크 증가 (페일로버 발생 시, 에포크 값 + 1)
4. 센티널 리더 선출
5. 복제본 선정 후 마스터로 승격
6. 복제 연결 변경
7. 장애 조치 완료

### 스플릿 브레인 현상

- 네트워크 파티션 이슈로 분산 환경의 데이터 저장소가 끊어지고, 끊긴 부분이 각각 정상적인 서비스라고 인식하는 현상
- 노드간 네트워크 단절 시, 마스터의 장애로 인식해 복제본 노드가 승격하면서 2개의 마스터가 생긴다.
- 새로 레디스로 연결되는 클라이언트는 승격된 마스터로 연결되고, 네트워크 단절이 복구되면 기존 마스터가 복제본이 되면서 기존 마스터가 처리한 데이터가 유실된다.

